{% extends "base.html" %}
{% block title %}Register{% endblock %}
{% block content %}
<div class="row justify-content-center py-5">
    <div class="col-md-7">
        <div class="glass-card p-5" style="border: 2px solid var(--border-medium);">
            <div class="mb-5">
                <div class="accent-dot mb-3"></div>
                <h2 class="fw-bold mb-2" style="font-size: 2.5rem;">Create Account</h2>
                <p class="text-muted">Join your college's academic management system</p>
            </div>

            <form method="POST" action="">
                {{ form.hidden_tag() }}

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        {{ form.role.label(class="form-label") }}
                        {{ form.role(class="form-select form-control-futuristic", id="role_select") }}
                    </div>

                    <div class="col-md-6" id="college_dropdown_div">
                        {{ form.college.label(class="form-label") }}
                        {{ form.college(class="form-select form-control-futuristic") }}
                    </div>

                    <div class="col-md-6" id="college_id_div">
                        {{ form.college_id.label(class="form-label") }}
                        {{ form.college_id(class="form-control form-control-futuristic", placeholder="e.g., CIDA001") }}
                        <div class="form-text">Contact your administrator for your College ID.</div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        {{ form.username.label(class="form-label") }}
                        {{ form.username(class="form-control form-control-futuristic", placeholder="john_doe") }}
                        {% if form.username.errors %}
                        {% for error in form.username.errors %}<div class="text-danger small mt-2">{{ error }}</div>{%
                        endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control form-control-futuristic", placeholder="john@college.edu") }}
                        {% if form.email.errors %}
                        {% for error in form.email.errors %}<div class="text-danger small mt-2">{{ error }}</div>{%
                        endfor %}
                        {% endif %}
                    </div>
                </div>

                <div class="mb-4" id="reg_num_div">
                    {{ form.register_number.label(class="form-label") }}
                    {{ form.register_number(class="form-control form-control-futuristic", placeholder="REG2024001") }}
                    {% if form.register_number.errors %}
                    {% for error in form.register_number.errors %}<div class="text-danger small mt-2">{{ error }}</div>
                    {% endfor %}
                    {% endif %}
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        {{ form.password.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.password(class="form-control form-control-futuristic", id="password_input",
                            placeholder="••••••••") }}
                            <button class="btn btn-outline-futuristic border-start-0" type="button" id="togglePassword">
                                <i class="fas fa-eye text-accent"></i>
                            </button>
                        </div>
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="d-flex gap-1 mb-2" id="strengthBars">
                                <div class="flex-grow-1"
                                    style="height: 3px; background: var(--border-medium); border-radius: 2px;"></div>
                                <div class="flex-grow-1"
                                    style="height: 3px; background: var(--border-medium); border-radius: 2px;"></div>
                                <div class="flex-grow-1"
                                    style="height: 3px; background: var(--border-medium); border-radius: 2px;"></div>
                                <div class="flex-grow-1"
                                    style="height: 3px; background: var(--border-medium); border-radius: 2px;"></div>
                            </div>
                            <small id="strengthText" class="text-muted"></small>
                        </div>
                        {% if form.password.errors %}
                        {% for error in form.password.errors %}<div class="text-danger small mt-2">{{ error }}</div>{%
                        endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.confirm_password.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.confirm_password(class="form-control form-control-futuristic",
                            id="confirm_password_input",
                            placeholder="••••••••") }}
                            <button class="btn btn-outline-futuristic border-start-0" type="button"
                                id="toggleConfirmPassword">
                                <i class="fas fa-eye text-accent"></i>
                            </button>
                        </div>
                        {% if form.confirm_password.errors %}
                        {% for error in form.confirm_password.errors %}<div class="text-danger small mt-2">{{ error }}
                        </div>{% endfor %}
                        {% endif %}
                    </div>
                </div>

                <div class="d-grid mt-5">
                    {{ form.submit(class="btn btn-futuristic py-3") }}
                </div>
            </form>

            <div class="text-center mt-4 pt-3" style="border-top: 1px solid var(--border-subtle);">
                <p class="text-muted small mb-0">
                    Already have an account?
                    <a href="{{ url_for('auth.login') }}" class="text-accent fw-semibold text-decoration-none">Sign
                        In</a>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const roleSelect = document.getElementById('role_select');
        const collegeDropdownDiv = document.getElementById('college_dropdown_div');
        const collegeIdDiv = document.getElementById('college_id_div');
        const regNumDiv = document.getElementById('reg_num_div');
        const passwordInput = document.getElementById('password_input');
        const confirmPasswordInput = document.getElementById('confirm_password_input');
        const togglePasswordBtn = document.getElementById('togglePassword');
        const toggleConfirmPasswordBtn = document.getElementById('toggleConfirmPassword');

        function toggleFields() {
            const role = roleSelect.value;
            collegeDropdownDiv.style.display = 'none';
            collegeIdDiv.style.display = 'none';
            regNumDiv.style.display = 'none';

            if (role === 'Admin') {
                collegeDropdownDiv.style.display = 'block';
            } else if (role === 'Teacher') {
                collegeIdDiv.style.display = 'block';
            } else if (role === 'Student') {
                collegeIdDiv.style.display = 'block';
                regNumDiv.style.display = 'block';
            }
        }

        // Password visibility toggle
        togglePasswordBtn.addEventListener('click', function () {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.querySelector('i').classList.toggle('fa-eye');
            this.querySelector('i').classList.toggle('fa-eye-slash');
        });

        // Confirm password visibility toggle
        toggleConfirmPasswordBtn.addEventListener('click', function () {
            const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPasswordInput.setAttribute('type', type);
            this.querySelector('i').classList.toggle('fa-eye');
            this.querySelector('i').classList.toggle('fa-eye-slash');
        });

        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            const bars = document.querySelectorAll('#strengthBars > div');
            const strengthText = document.getElementById('strengthText');

            if (password.length === 0) {
                bars.forEach(bar => bar.style.background = 'var(--border-medium)');
                strengthText.textContent = '';
                return;
            }

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            // Limit to 4 bars
            strength = Math.min(strength, 4);

            // Update bars
            bars.forEach((bar, index) => {
                if (index < strength) {
                    if (strength === 1) bar.style.background = '#ff4444';
                    else if (strength === 2) bar.style.background = '#ffaa00';
                    else if (strength === 3) bar.style.background = '#ffdd00';
                    else bar.style.background = 'var(--accent-primary)';
                } else {
                    bar.style.background = 'var(--border-medium)';
                }
            });

            // Update text
            const messages = [
                '',
                'Weak - Add more characters',
                'Fair - Add numbers or symbols',
                'Good - Consider adding special characters',
                'Strong - Excellent password!'
            ];
            strengthText.textContent = messages[strength];
            strengthText.style.color = strength >= 3 ? 'var(--accent-primary)' : 'var(--text-muted)';
        }

        passwordInput.addEventListener('input', function () {
            checkPasswordStrength(this.value);
        });

        roleSelect.addEventListener('change', toggleFields);
        toggleFields();
    });
</script>
{% endblock %}